name: Generate Dynamic Package Config

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['**/*.lua', '**/*.toc', '**/*.xml']

jobs:
  update-pkgmeta:
    name: Update .pkgmeta with current addon list
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0

      # Générer dynamiquement la liste des fichiers à ignorer
      - name: Generate dynamic .pkgmeta
        run: |
          echo "📦 Génération dynamique du .pkgmeta..."
          
          # Créer le fichier .pkgmeta
          cat > .pkgmeta << 'EOF'
          package-as: GuildLogistics
          
          manual-changelog: CHANGELOG.md
          
          # Fichiers et dossiers de développement à exclure du package
          ignore:
              - .github/
              - .gitignore
              - .vscode/
              - .pkgmeta
              - cliff.toml
              - README.md
              - CHANGELOG.md
              - LATEST_CHANGELOG.md
          EOF
          
          echo "✅ .pkgmeta généré pour structure directe"
          echo ""
          echo "📋 Contenu généré :"
          cat .pkgmeta

      # Vérifier si le fichier a changé
      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet .pkgmeta; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "ℹ️ Aucun changement dans .pkgmeta"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "✅ .pkgmeta mis à jour"
          fi

      # Committer les changements si nécessaire
      - name: Commit updated .pkgmeta
        if: steps.check-changes.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .pkgmeta
          git commit -m "chore: update .pkgmeta with current addon list [skip ci]"
          git push
